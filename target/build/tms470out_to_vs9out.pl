use strict;
#----------------------------  emmc_drv.pjt - Debug  ----------------------------
#[pinmux_fwrk.c] "C:\Program Files\TMS470 Code Generation Tools 4.4.8\bin\cl470" -g -px -al -fr"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -ff"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../utils/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../common/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/3430sdp/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../disp/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/omap3430/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/Common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/src/devices/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/src/" -d"_DEBUG" -d"OMAP3430SDP" -d"EMMC_DRV" -me -mt -mv4 --abi=tiabi --gcc -@"../../../../flashdrv/build/Debug.lkf" "pinmux_fwrk.c"
#[triton2.c] "C:\Program Files\TMS470 Code Generation Tools 4.4.8\bin\cl470" -g -px -al -fr"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -ff"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../utils/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../common/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/3430sdp/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../disp/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/omap3430/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/Common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/src/devices/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/src/" -d"_DEBUG" -d"OMAP3430SDP" -d"EMMC_DRV" -me -mt -mv4 --abi=tiabi --gcc -@"../../../../flashdrv/build/Debug.lkf" "triton2.c"
#[triton2_utils.c] "C:\Program Files\TMS470 Code Generation Tools 4.4.8\bin\cl470" -g -px -al -fr"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -ff"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../utils/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../common/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/3430sdp/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../disp/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/omap3430/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/Common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/src/devices/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/src/" -d"_DEBUG" -d"OMAP3430SDP" -d"EMMC_DRV" -me -mt -mv4 --abi=tiabi --gcc -@"../../../../flashdrv/build/Debug.lkf" "triton2_utils.c"
#"triton2_utils.c", line 637: warning: variable "triton2_handle" was declared but never referenced
#[Linking...] "C:\Program Files\TMS470 Code Generation Tools 4.4.8\bin\cl470" -@"Debug.lkf"
#<Linking>
#warning: no suitable entry-point found; setting to 0
#cd
#C:\CCSTG_C\a0394914_omapflash2s_view\OMAPSW_DP\omapflash\host
#del Targets\Flash-Drivers\emmc_drv.bin
#"C:\Program Files\Texas Instruments\CSST_v2.6.2\csstcli" sign -genraw -i ..\_out_\bin\flashdrv\Debug\emmc_drv.out -o Targets\Flash-Drivers\emmc_drv.bin
#Raw binary image generated successfully.
#Build Complete,
#  0 Errors, 14 Warnings, 0 Remarks.
#  Please view the build output for errors and warnings for any custom steps.
#Build log was saved at "file://c:\CCSTG_C\a0394914_omapflash2s_view\OMAPSW_DP\omapflash\flashdrv\Simulation\emmc_drv\Debug\BuildLog.htm"
#emmc_drv - 0 error(s), 38 warning(s)
my $pjt;
my $project;
my $config;
my %source;
my $partial;
my $prev;
my $failed;
my $log = "tms470out_to_vs9out.log";
open(LOG, ">$log") or die "$log $!";
print "tms470out_to_vs9out.pl\n";
while(<>){
    print LOG "$_";
    if (/^>> Compilation failure\s*$/) {                            # capture for final verdict for exit
        $failed = 1;
    }
    
    if (/^\s*$/){                                                   # ignore empty lines
        next;
    }
    
    if ($prev && s/^   //){                                         # undo long line wrapping
        $prev =~ s/\r?\n?$//;
        $prev = "$prev$_";
        next;
    }
    my $next = $_;
    $_ = $prev;
    $prev = $next;
    unless (defined $_){
        next;
    }
    my $text = $_;
    
    # note output has 14 dasches and 2 spaces
    if (/^----------* +(\w+\.pjt) - (\w+) +----------*\s*$/){       # capture current project (needed to get file locations)
        $pjt = $1;
        $config = $2;
        $project = undef;
        %source =();
    }
    
    #[pinmux_fwrk.c] "C:\Program Files\TMS470 Code Generation Tools 4.4.8\bin\cl470" -g -px -al -fr"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -ff"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../_out_/obj/flashdrv/Debug" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../utils/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../common/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/3430sdp/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../disp/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/omap3430/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/silicon/Common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../3430/src/platform/common/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../dalfwrk/src/devices/inc/" -i"C:/CCSTG_C/a0394914_omapflash2s_view/OMAPSW_DP/omapflash/flashdrv/build/../../flashdrv/src/" -d"_DEBUG" -d"OMAP3430SDP" -d"EMMC_DRV" -me -mt -mv4 --abi=tiabi --gcc -@"../../../../flashdrv/build/Debug.lkf" "pinmux_fwrk.c"
    #^                                                                        ^^^^^
    if (/^\[.*\bcl470\b.* -fr"([^"]*[\\\/]omapflash[\\\/][^"]*?)[\\\/]\.\.[\\\/]([^"]*)" /i){
        my $save = $_;
        if (!defined $project){                                     # get file locations from project files
            my $projectDir = $1;
            $project = "$projectDir/$pjt";
            if (open PRJ, $project) {
                while (<PRJ>){
                    if(/^Source="([^"]*?([-\w]+\.\w+))"\s*$/){
                        my $file = $2;
                        my $path ="$projectDir/$1";
                        $path =~ s/\//\\/g;
                        $path =~ s/\\\.(?=\\)//g;
                        while($path =~ s/\\(?!\.\.\\)[^\\]+\\\.\.(?=\\)//g) {}
                        $source{$file}=$path;
                    }
                }
                close PRJ;
            }
            else {
                print "Can't open $project $!\n";
            }
        }
        $_ = $save;
    }
    
    s/\s*$//;
    #s/^"([^"]*)", line (\d*):/$1($2):/;
    if (s/^"([^"]*)", (ERROR!   )?line (\d*)://) {                  # convert tms line format to VS line format (c no $2 or asm with $2)
        my $file = $1;
        my $kind = $2;
        my $line = $3;
        #if ($file =~ /^(\w+\.\w+/ &&){
        if (exists $source{$file}){                                 # ... add file location to line
            $file = $source{$file};
        }
        else{
            $file =~ s/\\\.(?=\\)//g;
            while($file =~ s/\\(?!\.\.\\)[^\\]+\\\.\.(?=\\)//g) {}
        }        
        $_ = "$file($line):$kind$_";
    }
    
    print "$_\n";                                                   # output VS line format
    
                                                                    # check if related location line needed
    #...: error #148: declaration is incompatible with "BOOLEAN debug_led_toggle(T_debug_led, U32)" (declared at line 93 of "c:/CCSTG_C/a0394914_omapflash3.1s_view/OMAPSW_DP/omapflash/3430/build/projects/../../../dnld/inc/disp.h")
    if (/\(declared at line (\d+) of "([^"]+)"\)\s*$/) {
        my $file = $2;
        my $line = $1;
        if (exists $source{$file}){
            $file = $source{$file};
        }
        else{
            $file =~ s/\\\.(?=\\)//g;
            while($file =~ s/\\(?!\.\.\\)[^\\]+\\\.\.(?=\\)//g) {}
        }        
        $_ = "$file($line): related location";
        print "$_\n";        
    }
}
close LOG;
if ($failed){                                                       # we piped compiler output so compiler exit code is lost
    #print "Compilation failed\n";
    exit(1);                                                        # ... generate a new exit code
                                                                    # hmmm... still not noticed by VS
}